{% extends "base.html" %}

{% block title %}Ingest Data{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-body">
        <h3 class="mb-3">üì• Data Ingestion</h3>

        <p class="text-muted">
            Paste <strong>Arabic text</strong> below to ingest it into the Qdrant context collection.
        </p>        

        <div class="mb-3">
            <label class="form-label">Text to ingest</label>
            <textarea
                id="ingest-text"
                class="form-control"
                rows="6"
                placeholder="ÿßŸÑÿµŸÇ ŸÜÿµŸãÿß ÿπÿ±ÿ®ŸäŸãÿß ŸáŸÜÿß..."
            ></textarea>
        </div>

        <button id="ingest-btn" class="btn btn-primary">
            Start Ingestion
        </button>

        <div id="ingest-status" class="mt-3"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const btn = document.getElementById("ingest-btn");
const statusDiv = document.getElementById("ingest-status");
const textInput = document.getElementById("ingest-text");

btn.addEventListener("click", async () => {
    const text = textInput.value.trim();

    if (!text) {
        statusDiv.innerHTML =
            `<div class="alert alert-warning">‚ö†Ô∏è Please enter text to ingest.</div>`;
        return;
    }

    btn.disabled = true;
    statusDiv.innerHTML =
        `<div class="alert alert-info">‚è≥ Ingestion in progress...</div>`;

    try {
        const res = await fetch("/api/ingest/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-API-KEY": "yafahala2810khkh"   // will be replaced later with session based auth 'after building the login part'
            },
            body: JSON.stringify({
                text: text
            })
        });

        const data = await res.json();

        if (!res.ok) {
            throw new Error(data.error || "Ingestion failed");
        }

        statusDiv.innerHTML =
            `<div class="alert alert-success">Ingestion completed successfully</div>`;
        textInput.value = "";
    } catch (err) {
        statusDiv.innerHTML =
            `<div class="alert alert-danger">${err.message}</div>`;
    } finally {
        btn.disabled = false;
    }
});
</script>
{% endblock %}
